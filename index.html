<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1.0, viewport-fit=cover"
  />
  <title>CBAM Expert Platform</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <!-- jsPDF for PDF export (no styling/colors set programmatically) -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    :root {
      --brand:#060496; --brand-2:#4040c8; --ink:#1a1a1a; --muted:#666;
      --card: rgba(255,255,255,0.92); --glass: rgba(255,255,255,0.84);
    }
    body { font-family:'Poppins',sans-serif; background:linear-gradient(135deg,#fafafa,#fff); color:var(--ink); line-height:1.6; }
    .header{ background:rgba(255,255,255,0.95); border-bottom:1px solid rgba(6,4,150,0.1); padding:1.5rem 3rem; display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:10; }
    .logo{ font-size:1.8rem; font-weight:700; background:linear-gradient(135deg,var(--brand),var(--brand-2)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent;}
    .nav-controls{ display:flex; gap:1rem; align-items:center; }
    .market-indicator{ display:flex; gap:.6rem; align-items:center; padding:.45rem 1rem; background:rgba(6,4,150,.06); border-radius:999px; font-weight:500; }
    .live-dot{ width:8px; height:8px; border-radius:999px; background:#22c55e; animation:pulse 2s infinite; }
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
    .lang-toggle{ display:flex; background:rgba(6,4,150,.06); padding:4px; border-radius:999px; }
    .lang-btn{ padding:8px 14px; border:none; background:transparent; border-radius:14px; cursor:pointer; font:500 14px Poppins; color:#555;}
    .lang-btn.active{ background:var(--brand); color:#fff;}
    .back-button{ display:none; border:1px solid rgba(6,4,150,.25); padding:.5rem .9rem; border-radius:12px; background:rgba(6,4,150,.06); color:var(--brand); cursor:pointer; }
    .container{ max-width:1400px; margin:0 auto; padding:3rem 1.4rem; }
    .dashboard{ display:block; }
    .hero-section{ text-align:center; margin-bottom:2rem;}
    .hero-title{ font-size:2.4rem; font-weight:700; background:linear-gradient(135deg,var(--brand),var(--brand-2)); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; }
    .hero-subtitle{ color:#666; max-width:880px; margin:.5rem auto 0; }
    .sections-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:1.4rem; margin-top:1.6rem;}
    .section-card{ background:var(--glass); border:1px solid rgba(6,4,150,.1); border-radius:18px; padding:1.6rem; cursor:pointer; transition:.2s; }
    .section-card:hover{ transform:translateY(-4px); box-shadow:0 16px 48px rgba(6,4,150,.18);}
    .section-icon{ font-size:2.2rem; }
    .section-title{ color:var(--brand); font-weight:600; margin:.4rem 0;}
    .section-description{ color:#666; }
    .section-features{ margin-top:.6rem; color:#777; font-size:.94rem; list-style:none; }
    .section-features li{ margin:.2rem 0; }
    .section-page{ display:none; }
    .section-header{ text-align:center; margin-bottom:1.2rem;}
    .section-page-title{ font-size:1.8rem; color:var(--brand); font-weight:700;}
    .section-page-subtitle{ color:#666; }
    .btn{ background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; border:none; padding:.6rem .9rem; border-radius:12px; cursor:pointer; font-weight:600; }
    .btn.secondary{ background:#fff; color:var(--brand); border:1px solid rgba(6,4,150,.25);}
    .mini{ padding:.45rem .7rem; font-size:.92rem; }
    .table-card,.document-card,.chat-container,.upload-card,.validation-card{ background:var(--card); border:1px solid rgba(6,4,150,.1); border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.06); }
    .table-card{ padding:1rem; }
    table{ width:100%; border-collapse:collapse; font-size:.95rem; }
    th,td{ border-bottom:1px solid #eee; padding:.5rem .6rem; text-align:left; }
    .documents-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(260px,1fr)); gap:1rem; margin:1.2rem 0; }
    .document-card{ padding:1rem; }
    .document-title{ color:var(--brand); font-weight:600; }
    .conversation-container{ max-width:960px; margin:0 auto; }
    .chat-container{ padding:1rem; }
    .messages-container{ min-height:260px; max-height:420px; overflow:auto; margin-bottom:.6rem; }
    .message{ margin:.6rem 0; }
    .message-user{ display:flex; justify-content:flex-end; }
    .message-assistant{ display:flex; justify-content:flex-start; }
    .message-content{ border-radius:14px; padding:.7rem .9rem; max-width:80%; }
    .message-user .message-content{ background:linear-gradient(135deg,var(--brand),var(--brand-2)); color:#fff; }
    .message-assistant .message-content{ background:#f7f8ff; border:1px solid rgba(6,4,150,.1); }
    .input-section{ display:flex; gap:.5rem; }
    .chat-input{ flex:1; border:1px solid #ddd; border-radius:12px; padding:.6rem .8rem; font:500 1rem Poppins;}
    .upload-container{ max-width:960px; margin:0 auto; }
    .upload-card{ padding:1.2rem; text-align:center; border:2px dashed rgba(6,4,150,.25); }
    .pill{ display:inline-block; padding:.18rem .5rem; border-radius:999px; border:1px solid rgba(6,4,150,.25); background:rgba(6,4,150,.06); font-size:.82rem; }
    .cta-footer{ margin-top:1rem; padding:.8rem 1rem; border-radius:12px; background:rgba(6,4,150,.06); border:1px dashed rgba(6,4,150,.25); display:flex; flex-wrap:wrap; gap:.6rem; align-items:center; justify-content:space-between; }
    .small{ font-size:.9rem; color:#666;}
    .row-actions button{ margin-right:.3rem; }
    .flex{ display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
    .right{ display:flex; gap:.5rem; align-items:center; }
    .contact-form{ display:flex; gap:.6rem; flex-wrap:wrap; align-items:center; }
    .contact-form input{ border:1px solid #ddd; border-radius:10px; padding:.45rem .6rem; font:500 .95rem Poppins; }
    @media (max-width:768px){ .messages-container{ max-height:360px; } }
  </style>
</head>
<body>
  <div class="header">
    <div class="logo">CBAM Expert</div>
    <div class="nav-controls">
      <button class="back-button" id="back-button" onclick="goHome()">‚Üê Back</button>
      <div class="market-indicator"><div class="live-dot"></div><span id="eua-box">EUA ‚Äî loading‚Ä¶</span></div>
      <div class="lang-toggle">
        <button class="lang-btn active" data-lang="en" onclick="setLang('en')">EN</button>
        <button class="lang-btn" data-lang="de" onclick="setLang('de')">DE</button>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
      <div class="hero-section">
        <h1 class="hero-title">CBAM Implementation Platform</h1>
        <p class="hero-subtitle">Governance ‚Üí Data pipeline ‚Üí Calculation & QA ‚Üí Verification & Registry ‚Üí Finance ‚Üí Audit trail. Fully client-side validator + templates, optional logging & PDF exports.</p>
      </div>

      <div class="sections-grid">
        <div class="section-card" onclick="showSection('informative')">
          <div class="section-icon">üìö</div>
          <div class="section-title">Implementation Guide</div>
          <div class="section-description">Step-by-step operating model for CBAM</div>
          <ul class="section-features">
            <li>RACI & SOPs</li><li>Supplier pipeline</li><li>QA & Controls</li><li>Registry & finance</li>
          </ul>
        </div>
        <div class="section-card" onclick="showSection('documents')">
          <div class="section-icon">üìã</div>
          <div class="section-title">Documents & Templates</div>
          <div class="section-description">CSV templates aligned with validator</div>
          <ul class="section-features">
            <li>Supplier request pack</li><li>Emissions CSV</li><li>CN mapping</li><li>Evidence list</li>
          </ul>
        </div>
        <div class="section-card" onclick="showSection('conversation')">
          <div class="section-icon">ü§ñ</div>
          <div class="section-title">Process Advisory</div>
          <div class="section-description">Checklists for execution questions</div>
        </div>
        <div class="section-card" onclick="showSection('upload')">
          <div class="section-icon">‚úÖ</div>
          <div class="section-title">Template Validation</div>
          <div class="section-description">EU-style rules, QC report, normalized export, PDF</div>
        </div>
      </div>
    </div>

    <!-- Implementation Guide -->
    <div class="section-page" id="informative-section">
      <div class="section-header"><h1 class="section-page-title">CBAM Implementation Guide</h1><p class="section-page-subtitle">Use this as your operating manual.</p></div>
      <div class="flex right" style="margin-bottom:.6rem;">
        <button class="btn mini" onclick="window.print()">Export as PDF</button>
        <button class="btn secondary mini" onclick="downloadText('cbam_action_plan.csv', actionPlanToCSV())">Export Action Plan (CSV)</button>
      </div>
      <div class="table-card">
        <div class="flex" style="justify-content:space-between;">
          <h3 style="color:var(--brand)">Action Plan (Live Tracker)</h3>
          <div class="right">
            <button class="btn secondary mini" onclick="addActionRow()">Add Task</button>
            <button class="btn secondary mini" onclick="clearCompleted()">Clear Completed</button>
            <button class="btn secondary mini" onclick="resetActionPlan()">Reset</button>
          </div>
        </div>
        <div style="overflow-x:auto;">
          <table id="action-plan">
            <thead><tr><th>‚úî</th><th>Task</th><th>Owner</th><th>Due</th><th>Phase</th><th>Status</th><th></th></tr></thead>
            <tbody id="action-plan-body"></tbody>
          </table>
        </div>
        <div class="cta-footer small">
          <div><strong>Execution support?</strong> Entrenovu Hub can run supplier data, verification, registry, finance.</div>
          <div class="right"><a class="btn mini" href="mailto:info@entrenovu.com">info@entrenovu.com</a><a class="btn secondary mini" href="tel:+436506965789">+43 650 6965 789</a></div>
        </div>
      </div>
    </div>

    <!-- Documents & Templates -->
    <div class="section-page" id="documents-section">
      <div class="section-header"><h1 class="section-page-title">Documents & Templates</h1><p class="section-page-subtitle">Aligned with the validator</p></div>
      <div class="documents-grid" id="docs-grid"></div>
    </div>

    <!-- Process Advisory -->
    <div class="section-page" id="conversation-section">
      <div class="section-header"><h1 class="section-page-title">Process Advisory</h1><p class="section-page-subtitle">Tactical, checklist-first responses.</p></div>
      <div class="conversation-container">
        <div class="chat-container">
          <div class="messages-container" id="messages"></div>
          <div class="input-section">
            <input id="chat-input" class="chat-input" placeholder="Ask: How do we enforce SLAs with suppliers that delay data?" />
            <button class="btn" onclick="sendMessage()">Send ‚û§</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Upload & Validation -->
    <div class="section-page" id="upload-section">
      <div class="section-header"><h1 class="section-page-title">Template Validation</h1><p class="section-page-subtitle">Upload a CSV/JSON. We validate against EU-style rules and return a QC report + normalized CSV + PDF summary.</p></div>
      <div class="upload-container">
        <div class="upload-card">
          <div style="font-size:2rem;">üì•</div>
          <div style="margin:.4rem 0;">Select CSV/JSON</div>
          <input type="file" id="file-input" accept=".csv,.json" />
          <div id="upload-status" class="small" style="margin-top:.5rem;"></div>
        </div>

        <div class="table-card" id="summary-card" style="display:none;">
          <div class="flex" style="justify-content:space-between; margin-bottom:.4rem;">
            <div class="flex" style="gap:.5rem;">
              <span id="summary-file" class="pill">File: ‚Äî</span>
              <span id="summary-rows" class="pill">Rows: ‚Äî</span>
              <span id="summary-complete" class="pill">Completeness: ‚Äî</span>
              <span id="summary-period" class="pill">Period: ‚Äî</span>
              <span id="summary-badge" class="pill">Badge: ‚Äî</span>
            </div>
            <div class="right">
              <button class="btn secondary mini" id="btn-report" disabled>Download QC Report (CSV)</button>
              <button class="btn secondary mini" id="btn-normalized" disabled>Download Normalized (CSV)</button>
              <button class="btn mini" id="btn-pdf" disabled>Download PDF Summary</button>
            </div>
          </div>
          <div id="issues"></div>
        </div>

        <div class="cta-footer">
          <form id="contact-form" class="contact-form" onsubmit="return saveSubmission(event)">
            <span class="small">Optional ‚Äî log this validation to get a copy:</span>
            <input type="text" id="company" name="company" placeholder="Company" />
            <input type="email" id="email" name="email" placeholder="Email" />
            <input type="text" id="contact" name="contact" placeholder="Contact person" />
            <button class="btn secondary mini" type="submit">Save to log</button>
          </form>
          <div class="small">We store only what you submit here + validation summary.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    /************** CONFIG (optional) **************/
    // If you deploy a Google Apps Script Web App (Exec as Me; Anyone with link),
    // set its URL here to log submissions to Google Sheets:
    const GAS_WEBAPP_URL = ""; // e.g. "https://script.google.com/macros/s/XXXX/exec"

    // If you have an EUA JSON feed that returns { price, change }, set it here:
    const EUA_FEED_URL = ""; // optional
    const EUA_FALLBACK = { price: "64.15", change: "+1.2%" };

    /************** Router / Language **************/
    function showSection(key){
      document.getElementById('dashboard').style.display='none';
      document.getElementById('back-button').style.display='inline-block';
      ['informative','documents','conversation','upload'].forEach(id=>{
        document.getElementById(id+'-section').style.display = (id===key?'block':'none');
      });
      window.scrollTo({top:0,behavior:'smooth'});
    }
    function goHome(){
      document.getElementById('dashboard').style.display='block';
      document.getElementById('back-button').style.display='none';
      ['informative','documents','conversation','upload'].forEach(id=>{
        document.getElementById(id+'-section').style.display='none';
      });
    }
    function setLang(){ /* i18n hook */ }

    /************** EUA price (best effort) **************/
    async function fetchEUA(){
      try{
        if(EUA_FEED_URL){
          const r = await fetch(EUA_FEED_URL, { cache:'no-store' });
          const j = await r.json();
          document.getElementById('eua-box').textContent = `EUA ‚Ç¨${j.price || EUA_FALLBACK.price} (${j.change || EUA_FALLBACK.change})`;
          return;
        }
      }catch(e){}
      document.getElementById('eua-box').textContent = `EUA ‚Ç¨${EUA_FALLBACK.price} (${EUA_FALLBACK.change})`;
    }
    fetchEUA();

    /************** Action plan (localStorage) **************/
    const phases = ['Foundation','Suppliers','Calc & QA','Verification','Finance','Audit','Milestones'];
    const actionKey='cbam_action_plan_v2';
    function futureDate(d){ const dt=new Date(); dt.setDate(dt.getDate()+d); return dt.toISOString().slice(0,10); }
    function defaultPlan(){ return [
      {done:false, task:'Publish RACI & appoint CBAM Lead', owner:'Legal', due:futureDate(7), phase:'Foundation', status:'Open'},
      {done:false, task:'Segment suppliers A/B/C', owner:'Procurement', due:futureDate(10), phase:'Suppliers', status:'Open'},
      {done:false, task:'Issue request pack to A-tier', owner:'Procurement', due:futureDate(12), phase:'Suppliers', status:'Open'},
      {done:false, task:'Define calc method & QA checklist', owner:'Sustainability', due:futureDate(14), phase:'Calc & QA', status:'Open'},
    ];}
    let plan = JSON.parse(localStorage.getItem(actionKey)||'null') || defaultPlan();
    function savePlan(){ localStorage.setItem(actionKey, JSON.stringify(plan)); }
    function renderPlan(){
      const tbody=document.getElementById('action-plan-body'); tbody.innerHTML='';
      plan.forEach((row,i)=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td><input type="checkbox" ${row.done?'checked':''} onchange="plan[${i}].done=this.checked; savePlan();"></td>
          <td contenteditable oninput="plan[${i}].task=this.innerText; savePlan();">${esc(row.task)}</td>
          <td contenteditable oninput="plan[${i}].owner=this.innerText; savePlan();">${esc(row.owner)}</td>
          <td><input type="date" value="${row.due}" onchange="plan[${i}].due=this.value; savePlan();"></td>
          <td><select onchange="plan[${i}].phase=this.value; savePlan();">${phases.map(p=>`<option ${p===row.phase?'selected':''}>${p}</option>`).join('')}</select></td>
          <td><select onchange="plan[${i}].status=this.value; savePlan();">${['Open','In progress','Blocked','Done'].map(s=>`<option ${s===row.status?'selected':''}>${s}</option>`).join('')}</select></td>
          <td class="row-actions"><button class="btn secondary mini" onclick="plan.splice(${i},1); savePlan(); renderPlan();">Del</button></td>`;
        tbody.appendChild(tr);
      });
    }
    function addActionRow(){ plan.push({done:false,task:'New task',owner:'',due:futureDate(7),phase:'Foundation',status:'Open'}); savePlan(); renderPlan(); }
    function clearCompleted(){ plan = plan.filter(r=>!r.done); savePlan(); renderPlan(); }
    function resetActionPlan(){ plan = defaultPlan(); savePlan(); renderPlan(); }
    function actionPlanToCSV(){ const header=['done','task','owner','due','phase','status']; return [header].concat(plan.map(r=>[r.done,r.task,r.owner,r.due,r.phase,r.status])).map(r=>r.map(csvEscape).join(',')).join('\n');}
    function esc(s){return String(s).replace(/[&<>"]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[m]));}
    function csvEscape(v){ if(v==null) return ''; let s=String(v); if(s.includes('"')) s=s.replace(/"/g,'""'); if(/[",\n]/.test(s)) s='"'+s+'"'; return s; }
    renderPlan();

    /************** Docs grid (client-side templates) **************/
    const TEMPLATES = {
      "cbam_supplier_data_template.csv":
        'supplier_id,supplier_name,country,product_cn_code,product_description,production_route,reporting_period_start,reporting_period_end,electricity_emissions_tCO2e,process_emissions_tCO2e,total_emissions_tCO2e,renewable_electricity_kWh,grid_emission_factor_tCO2e_per_MWh,verifier_name,verifier_accreditation_id\nS-001,Acme Steel,TR,7207,Semi-finished steel,EAF,2025-01-01,2025-03-31,120.5,35.2,155.7,250000,0.42,Verifier Ltd.,ACC-12345\n',
      "cn_product_mapping.csv":
        'product_cn_code,product_name,internal_sku,supplier_id,plant,priority_tier\n7207,Semi-finished steel,STL-001,S-001,Gebze,A\n',
      "verification_statement_template.csv":
        'supplier_id,verifier_name,accreditation_id,methodology_ref,evidence_links,comments\nS-001,Verifier Ltd.,ACC-12345,Specific emissions per plant,https://example.com,All meters calibrated in 2024\n',
      "evidence_checklist.csv":
        'area,item,required,retention_years,owner\nData,Raw meter logs (elec/process),Yes,10,Plant Ops\nCalc,Calc workbook (locked & signed),Yes,10,Sustainability\nVerification,NCRs & closure evidence,Yes,10,Sustainability\nLegal,Supplier declarations & SLA,Yes,10,Legal\nFinance,Accruals & reconciliations,Yes,10,Finance\n',
      "declaration_prep.csv":
        'period,cn_code,supplier_id,quantity_t,specific_emissions_tCO2e,default_emissions_tCO2e,emissions_used_tCO2e,notes\n2025-Q1,7207,S-001,1200,155.7,,155.7,Verified specific value\n',
      "supplier-letter.txt":
`Subject: CBAM data request ‚Äì action required

Dear Supplier,

We are implementing the EU Carbon Border Adjustment Mechanism (CBAM). Please provide emissions information for your products supplied to us for the reporting period indicated.

What you will receive:
1) CSV template (required columns and units)
2) Instructions & SLA
3) Examples

Deadlines:
‚Ä¢ A-tier suppliers: respond within 15 working days
‚Ä¢ B/C-tier: respond within 20 working days

Format & naming:
‚Ä¢ CSV or JSON
‚Ä¢ File name: <Supplier>_<CNCode>_<Period>.csv

Quality requirements:
‚Ä¢ Period start/end dates
‚Ä¢ Units in tCO2e
‚Ä¢ Electricity + process ‚âà total (¬±1%)
‚Ä¢ If verified: include verifier name and accreditation id

Send files to: cbam@yourcompany.com (or use our secure upload)
Questions: CBAM Lead via Legal.

Regards,
CBAM Program Office
`
    };
    const docs = [
      {icon:'üì®', title:'Supplier Request Pack', desc:'Cover note + SLA + instructions.', name:'supplier-letter.txt'},
      {icon:'üßæ', title:'Emissions Data Template', desc:'CSV suppliers fill. Validator-ready.', name:'cbam_supplier_data_template.csv'},
      {icon:'üîó', title:'CN ‚Üí Product Mapping', desc:'Link CN to your SKUs/suppliers.', name:'cn_product_mapping.csv'},
      {icon:'üß™', title:'Verification Statement', desc:'Fields verifiers expect.', name:'verification_statement_template.csv'},
      {icon:'üóÇÔ∏è', title:'Evidence & Audit Checklist', desc:'Retention evidence list.', name:'evidence_checklist.csv'},
      {icon:'üì§', title:'Quarterly Declaration Prep', desc:'Pre-structure period declaration.', name:'declaration_prep.csv'},
    ];
    const grid = document.getElementById('docs-grid');
    docs.forEach(d=>{
      const card = document.createElement('div'); card.className='document-card';
      card.innerHTML = `<div style="font-size:1.6rem">${d.icon}</div>
        <div class="document-title">${d.title}</div>
        <div class="small">${d.desc}</div>
        <div style="margin-top:.6rem;"><button class="btn mini">Download</button></div>`;
      card.querySelector('button').onclick = ()=> downloadText(d.name, TEMPLATES[d.name]);
      grid.appendChild(card);
    });

    /************** Process advisory (rule-based) **************/
    const messagesEl=document.getElementById('messages'); const chatInput=document.getElementById('chat-input');
    function addMessage(role,html){ const w=document.createElement('div'); w.className='message '+(role==='user'?'message-user':'message-assistant'); const b=document.createElement('div'); b.className='message-content'; b.innerHTML=html; w.appendChild(b); messagesEl.appendChild(w); messagesEl.scrollTop=messagesEl.scrollHeight; }
    function bulletify(title,items){ return `<strong>${title}</strong><ul>${items.map(i=>`<li>${i}</li>`).join('')}</ul>`; }
    function advise(q){
      const t=q.toLowerCase();
      if(t.includes('supplier')) return bulletify('Supplier Plan',['Segment A/B/C','SLA 15/20 wd','T+7/T+14 remind','Validation gate','Fallback default + improve']);
      if(t.includes('budget')||t.includes('certificate')) return bulletify('Finance',['Rolling 12M forecast','Buying windows','Pass-through clauses','Monthly accruals','Quarterly recon']);
      if(t.includes('audit')||t.includes('evidence')) return bulletify('Audit',['Raw logs','Locked calc','Approvals','Verifier NCRs','Retention ‚â•10y']);
      if(t.includes('cn')||t.includes('mapping')||t.includes('scope')) return bulletify('CN Mapping',['Export customs CNs','Link CN‚ÜíSKU','Prioritize 80% volume/value','Legal review ambiguous CNs']);
      if(t.includes('validate')||t.includes('validation')||t.includes('totals')) return bulletify('Validation Fix',['Columns exact','Units tCO‚ÇÇe','elec+process‚âàtotal (¬±1%)','Date format YYYY-MM-DD']);
      return bulletify('CBAM Model',['RACI owners','Monthly cadence','KPIs: response, pass rate, NCRs, timeliness, cost variance']);
    }
    function sendMessage(){ const v=chatInput.value.trim(); if(!v) return; addMessage('user',esc(v)); setTimeout(()=>addMessage('assistant', advise(v)),250); chatInput.value=''; }

    /************** Validator (client-side) **************/
    const SCHEMA = [
      { key:'supplier_id', req:true, type:'string' },
      { key:'supplier_name', req:true, type:'string' },
      { key:'country', req:true, type:'string' },
      { key:'product_cn_code', req:true, type:'string', pattern:/^\d{4,8}$/ },
      { key:'product_description', req:false, type:'string' },
      { key:'production_route', req:false, type:'string',
        allowed:['BF-BOF','EAF','DRI-EAF','Clinker','Ammonia-SMR','Ammonia-Electrolysis','Aluminium-prebake','Other'] },
      { key:'reporting_period_start', req:true, type:'date' },
      { key:'reporting_period_end', req:true, type:'date' },
      { key:'electricity_emissions_tCO2e', req:true, type:'number', min:0 },
      { key:'process_emissions_tCO2e', req:true, type:'number', min:0 },
      { key:'total_emissions_tCO2e', req:true, type:'number', min:0 },
      { key:'renewable_electricity_kWh', req:false, type:'number', min:0 },
      { key:'grid_emission_factor_tCO2e_per_MWh', req:false, type:'number', min:0 },
      { key:'verifier_name', req:false, type:'string' },
      { key:'verifier_accreditation_id', req:false, type:'string' },
    ];
    const ALLOWED_CN_PREFIX = [
      '2523','2716','2804','3102','3103','3104','3105',
      '7206','7207','7208','7209','7210','7211','7212','7213','7214','7215','7216','7217','7218','7219','7220','7221','7222','7223','7224','7225','7226','7227','7228','7229','7301',
      '7601','7606','7607'
    ];

    function normalizeKeys(row){
      const map={};
      Object.keys(row).forEach(k=>{
        const nk = String(k).trim().toLowerCase().replace(/\s+/g,'_');
        map[nk] = row[k];
      });
      const alias = {
        electricity_emissions: 'electricity_emissions_tCO2e',
        process_emissions: 'process_emissions_tCO2e',
        total_emissions: 'total_emissions_tCO2e',
        grid_factor_tco2e_per_mwh: 'grid_emission_factor_tCO2e_per_MWh'
      };
      Object.keys(alias).forEach(a=>{
        if(map[a]!==undefined && map[alias[a]]===undefined) map[alias[a]] = map[a];
      });
      return map;
    }
    function issue(level, title, where, details){ return { level, title, where, details }; }
    function toNumber(val){
      if(val===undefined || val===null || val==='') return null;
      const n = Number(String(val).replace(',', '.'));
      return Number.isNaN(n) ? NaN : n;
    }
    function isDateISO(val){ return /^\d{4}-\d{2}-\d{2}$/.test(String(val)); }

    function parseCSVFlexible(text){
      const firstLine = text.split(/\r?\n/).find(Boolean) || '';
      const delim = (firstLine.match(/;/g)||[]).length > (firstLine.match(/,/g)||[]).length ? ';' : ',';
      return parseCSV(text, delim);
    }
    function parseCSV(text, delimiter){
      const rows = [];
      const lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').split('\n');
      if(!lines.length) return rows;
      const header = splitCSVLine(lines[0], delimiter).map(h=>h.trim());
      for(let i=1;i<lines.length;i++){
        if(!lines[i].trim()) continue;
        const cells = splitCSVLine(lines[i], delimiter);
        const obj = {};
        header.forEach((h, idx)=>{ obj[h] = cells[idx]!==undefined ? cells[idx] : ''; });
        rows.push(obj);
      }
      return rows;
    }
    function splitCSVLine(line, delimiter){
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch = line[i];
        if(ch === '"'){ if(inQ && line[i+1]==='"'){ cur+='"'; i++; } else { inQ=!inQ; } }
        else if(ch===delimiter && !inQ){ out.push(cur); cur=''; }
        else{ cur+=ch; }
      }
      out.push(cur);
      return out.map(x=>x.trim());
    }

    function validateRows(rows){
      const normalized = rows.map(normalizeKeys);
      const report=[]; let errors=0; let warnings=0;
      const out=[]; const periods=[];

      const reqKeys = SCHEMA.filter(s=>s.req).map(s=>s.key);
      const present = Object.keys(normalized[0]||{});
      const completeness = Math.round(100 * reqKeys.filter(k=>present.includes(k)).length / reqKeys.length);

      normalized.forEach((row, i)=>{
        const idx = i+1;
        SCHEMA.forEach(col=>{
          const val = row[col.key];
          if(col.req && (val===undefined || val===null || val==='')){
            report.push(issue('critical', `Missing required column "${col.key}"`, `Row ${idx}`, `Add value for ${col.key}`)); errors++; return;
          }
          if(val!==undefined && val!==null && val!==''){
            if(col.type==='number'){
              const n = toNumber(val);
              if(Number.isNaN(n)){ report.push(issue('critical', `"${col.key}" must be numeric`, `Row ${idx}`, `Got "${val}"`)); errors++; }
              else{
                if(col.min!==undefined && n < col.min){ report.push(issue('critical', `"${col.key}" < ${col.min}`, `Row ${idx}`, `Got ${n}`)); errors++; }
                row[col.key] = n;
              }
            } else if(col.type==='date'){
              if(!isDateISO(val)){ report.push(issue('critical', `"${col.key}" must be YYYY-MM-DD`, `Row ${idx}`, `Got "${val}"`)); errors++; }
            } else if(col.pattern && !col.pattern.test(String(val))){
              report.push(issue('critical', `"${col.key}" format invalid`, `Row ${idx}`, `Got "${val}"`)); errors++;
            } else if(col.allowed && !col.allowed.includes(String(val))){
              report.push(issue('warning', `Unexpected value in "${col.key}"`, `Row ${idx}`, `Got "${val}". Allowed: ${col.allowed.join(', ')}`)); warnings++;
            }
          }
        });

        // CN coverage warn
        const cn = String(row.product_cn_code || '');
        if(cn && !ALLOWED_CN_PREFIX.some(pref => cn.startsWith(pref))){
          report.push(issue('warning','CN code may be out of CBAM scope',`Row ${idx}`,`CN ${cn} not in common CBAM ranges`)); warnings++;
        }

        // Math tolerance
        const e = row.electricity_emissions_tCO2e ?? null;
        const p = row.process_emissions_tCO2e ?? null;
        const t = row.total_emissions_tCO2e ?? null;
        if([e,p,t].every(v => typeof v === 'number')){
          const sum = e + p;
          const tol = Math.max(0.01 * Math.abs(sum), 0.5);
          if(Math.abs(sum - t) > tol){
            report.push(issue('critical', 'Totals mismatch', `Row ${idx}`, `electricity + process = ${sum.toFixed(2)} ‚â† total ${t.toFixed(2)} (tol ¬±${tol.toFixed(2)})`)); errors++;
          }
          if(t === 0){
            report.push(issue('warning','Zero emissions reported',`Row ${idx}`,`Confirm metering and methodology`)); warnings++;
          }
        }

        // Period
        const ps = row.reporting_period_start, pe = row.reporting_period_end;
        if(ps && pe && isDateISO(ps) && isDateISO(pe)){
          const s = new Date(ps), e2 = new Date(pe);
          if(s > e2){ report.push(issue('critical','Period start is after end',`Row ${idx}`,`${ps} ‚Üí ${pe}`)); errors++; }
          else periods.push([s,e2]);
        }

        out.push(row);
      });

      let periodSummary = 'n/a';
      if(periods.length){
        const minS = new Date(Math.min(...periods.map(p=>p[0].getTime())));
        const maxE = new Date(Math.max(...periods.map(p=>p[1].getTime())));
        periodSummary = `${minS.toISOString().slice(0,10)} ‚Üí ${maxE.toISOString().slice(0,10)}`;
      }
      const badge = errors>0 ? 'ERRORS' : warnings>0 ? 'WARNINGS' : 'VALID';

      return { normalized: out, report, summary: { rows: out.length, completeness, period: periodSummary, badge } };
    }

    function rowsToCSV(rows){
      const keys = Array.from(new Set(rows.flatMap(r => Object.keys(r))));
      const head = keys.join(',');
      const lines = rows.map(r=> keys.map(k=>{
        let v = r[k]; if(v==null) v='';
        let s = String(v); if(s.includes('"')) s=s.replace(/"/g,'""'); if(/[",\n]/.test(s)) s='"'+s+'"';
        return s;
      }).join(','));
      return [head].concat(lines).join('\n');
    }
    function reportToCSV(items){
      const header=['level','title','where','details'];
      const lines = items.map(i=>[i.level,i.title,i.where||'',i.details||''].map(v=>{
        let s=String(v||''); if(s.includes('"')) s=s.replace(/"/g,'""'); if(/[",\n]/.test(s)) s='"'+s+'"'; return s;
      }).join(','));
      return [header.join(',')].concat(lines).join('\n');
    }
    function downloadText(filename, content){
      const blob = new Blob([content], {type: filename.endsWith('.csv') ? 'text/csv;charset=utf-8;' : 'text/plain;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    // File input handler
    const fi = document.getElementById('file-input');
    fi.addEventListener('change', async (e)=> {
      const f = e.target.files?.[0]; if(!f) return;
      const st = document.getElementById('upload-status'); st.textContent='Reading file‚Ä¶';
      const reader = new FileReader();
      reader.onload = ()=>{
        try{
          const name = f.name.toLowerCase();
          let rows;
          if(name.endsWith('.json')){
            const j = JSON.parse(reader.result);
            rows = Array.isArray(j) ? j : (j.rows || []);
          } else {
            rows = parseCSVFlexible(reader.result);
          }
          if(!rows || !rows.length){ st.textContent='No rows found.'; return; }
          const result = validateRows(rows);
          st.textContent='Validation complete';
          renderSummary(f.name, result);
        }catch(err){
          st.textContent='Failed: '+err.message;
        }
      };
      reader.readAsText(f);
    });

    let lastValidation = null;
    function renderSummary(filename, data){
      lastValidation = data;
      const sc = document.getElementById('summary-card'); sc.style.display='block';
      document.getElementById('summary-file').textContent = 'File: '+filename;
      document.getElementById('summary-rows').textContent = 'Rows: '+data.summary.rows;
      document.getElementById('summary-complete').textContent = 'Completeness: '+data.summary.completeness+'%';
      document.getElementById('summary-period').textContent = 'Period: '+data.summary.period;
      document.getElementById('summary-badge').textContent = 'Badge: '+data.summary.badge;

      const issues = document.getElementById('issues'); issues.innerHTML='';
      data.report.forEach(it=>{
        const div=document.createElement('div'); div.style.padding='.5rem .6rem'; div.style.borderLeft=`3px solid ${it.level==='critical'?'#f87171':it.level==='warning'?'#fbbf24':'#3b82f6'}`;
        div.style.background=it.level==='critical'?'#fff5f5':it.level==='warning'?'#fff8eb':'#f5f8ff';
        div.style.borderRadius='8px'; div.style.margin='.35rem 0';
        div.innerHTML = `<strong>${esc(it.title)}</strong><div class="small">${esc(it.details||'')}</div><div class="small" style="opacity:.7">${esc(it.where||'')}</div>`;
        issues.appendChild(div);
      });

      const reportCSV = reportToCSV(data.report);
      const normalizedCSV = rowsToCSV(data.normalized);

      const btnRep=document.getElementById('btn-report'); btnRep.disabled=false; btnRep.onclick=()=>downloadText('validation_report.csv', reportCSV);
      const btnNorm=document.getElementById('btn-normalized'); btnNorm.disabled=false; btnNorm.onclick=()=>downloadText('normalized_data.csv', normalizedCSV);
      const btnPDF=document.getElementById('btn-pdf'); btnPDF.disabled=false; btnPDF.onclick=()=>downloadPDFSummary(data);
    }

    // PDF summary via jsPDF
    function downloadPDFSummary(data){
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit:'pt', format:'a4' });
      let y = 40;
      doc.setFontSize(16); doc.text('CBAM Validation Summary', 40, y); y += 18;
      doc.setFontSize(10); doc.text(`Generated: ${new Date().toISOString()}`, 40, y); y += 14;
      const s = data.summary;
      doc.text(`Rows: ${s.rows}`, 40, y); y += 12;
      doc.text(`Completeness: ${s.completeness}%`, 40, y); y += 12;
      doc.text(`Period: ${s.period}`, 40, y); y += 12;
      doc.text(`Badge: ${s.badge}`, 40, y); y += 18;
      doc.setFont(undefined, 'bold'); doc.text('Notes:', 40, y); doc.setFont(undefined, 'normal'); y += 14;
      const lines = [
        '‚Ä¢ Columns & types follow the platform schema aligned with CBAM transitional reporting.',
        '‚Ä¢ Totals check: electricity + process ‚âà total (¬±1% or min ¬±0.5 tCO‚ÇÇe).',
        '‚Ä¢ CN check warns when codes appear outside common CBAM ranges.'
      ];
      lines.forEach(l=>{ doc.text(l, 40, y); y += 12; });
      doc.save('cbam_validation_summary.pdf');
    }

    /************** Optional Google Sheets logging **************/
    async function saveSubmission(e){
      e.preventDefault();
      const payload = {
        ts: new Date().toISOString(),
        company: document.getElementById('company').value || '',
        email: document.getElementById('email').value || '',
        contact: document.getElementById('contact').value || '',
        summary: lastValidation?.summary || null
      };
      if(!GAS_WEBAPP_URL){
        alert('Saved locally (open dev tools ‚Üí Application ‚Üí Local Storage to view). Set GAS_WEBAPP_URL to log to Google Sheets.');
        const existing = JSON.parse(localStorage.getItem('cbam_local_logs') || '[]');
        existing.push(payload); localStorage.setItem('cbam_local_logs', JSON.stringify(existing));
        return false;
      }
      try{
        const r = await fetch(GAS_WEBAPP_URL, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
        if(!r.ok) throw new Error('Non-200');
        alert('Saved to Google Sheets.');
      }catch(err){
        alert('Could not save to Google Sheets (check URL/deployment).');
      }
      return false;
    }

    /************** Helpers **************/
    function downloadText(filename, content){
      const blob = new Blob([content], {type: filename.endsWith('.csv') ? 'text/csv;charset=utf-8;' : 'text/plain;charset=utf-8;'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a');
      a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    /************** Initialize **************/
    (function init(){
      // preload advisory greeting
      addMessage('assistant', '<strong>CBAM ‚Äì Operating Model</strong><ul><li>RACI owners</li><li>Monthly cadence</li><li>KPIs: response, pass rate, NCRs, timeliness, cost variance</li></ul>');
    })();
  </script>
</body>
</html>
